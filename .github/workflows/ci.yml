name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Run Tests and Quality Gates
        run: mvn clean verify
        continue-on-error: true

      - name: Parse Coverage and Quality Reports
        if: always()
        run: |
          # Extract JaCoCo coverage
          if [ -f target/site/jacoco/jacoco.csv ]; then
            COVERAGE=$(tail -1 target/site/jacoco/jacoco.csv | cut -d',' -f8,7 | awk -F',' '{covered=$1; missed=$2; total=covered+missed; if(total>0) printf "%.2f", (covered*100/total); else printf "0"}')
            COVERED=$(tail -1 target/site/jacoco/jacoco.csv | cut -d',' -f8)
            MISSED=$(tail -1 target/site/jacoco/jacoco.csv | cut -d',' -f7)
            TOTAL=$((COVERED + MISSED))
            echo "COVERAGE=$COVERAGE" >> "$GITHUB_ENV"
            echo "COVERED=$COVERED" >> "$GITHUB_ENV"
            echo "MISSED=$MISSED" >> "$GITHUB_ENV"
            echo "TOTAL=$TOTAL" >> "$GITHUB_ENV"
          else
            echo "COVERAGE=0" >> "$GITHUB_ENV"
            echo "COVERED=0" >> "$GITHUB_ENV"
            echo "MISSED=0" >> "$GITHUB_ENV"
            echo "TOTAL=0" >> "$GITHUB_ENV"
          fi

          # Extract PMD violations by priority
          if [ -f target/pmd.xml ]; then
            P1_COUNT=$(grep -c 'priority="1"' target/pmd.xml 2>/dev/null || echo 0)
            P2_COUNT=$(grep -c 'priority="2"' target/pmd.xml 2>/dev/null || echo 0)
            P3_COUNT=$(grep -cE 'priority="[3-5]"' target/pmd.xml 2>/dev/null || echo 0)
            echo "P1_VIOLATIONS=$P1_COUNT" >> "$GITHUB_ENV"
            echo "P2_VIOLATIONS=$P2_COUNT" >> "$GITHUB_ENV"
            echo "P3_VIOLATIONS=$P3_COUNT" >> "$GITHUB_ENV"
          else
            echo "P1_VIOLATIONS=0" >> "$GITHUB_ENV"
            echo "P2_VIOLATIONS=0" >> "$GITHUB_ENV"
            echo "P3_VIOLATIONS=0" >> "$GITHUB_ENV"
          fi

      - name: Generate Job Summary
        if: always()
        run: |
          echo "# Quality Gates Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage section
          if [ -n "${{ env.COVERAGE }}" ] && [ "${{ env.COVERAGE }}" != "0" ]; then
            COVERAGE_PCT="${{ env.COVERAGE }}"
            if (( $(echo "$COVERAGE_PCT < 80" | bc -l) )); then
              COVERAGE_BADGE="![Coverage](https://img.shields.io/badge/Coverage-${COVERAGE_PCT}%25-red?style=flat)"
              COVERAGE_STATUS="âŒ FAILED"
            else
              COVERAGE_BADGE="![Coverage](https://img.shields.io/badge/Coverage-${COVERAGE_PCT}%25-brightgreen?style=flat)"
              COVERAGE_STATUS="âœ… PASSED"
            fi
            
            echo "## Code Coverage $COVERAGE_BADGE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lines Covered | ${{ env.COVERED }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines Missed | ${{ env.MISSED }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Lines | ${{ env.TOTAL }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage % | ${{ env.COVERAGE }}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Target | â‰¥ 80% |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | $COVERAGE_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # PMD section
          if [ -n "${{ env.P1_VIOLATIONS }}" ]; then
            P1="${{ env.P1_VIOLATIONS }}"
            P2="${{ env.P2_VIOLATIONS }}"
            echo "## Code Quality (PMD)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Priority | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            [ "$P1" -eq 0 ] && P1_STATUS="âœ…" || P1_STATUS="âŒ"
            [ "$P2" -eq 0 ] && P2_STATUS="âœ…" || P2_STATUS="âŒ"
            echo "| ðŸ”´ Blocker (P1) | $P1 | $P1_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  Critical (P2) | $P2 | $P2_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Warning (P3+) | ${{ env.P3_VIOLATIONS }} | â„¹ï¸ (allowed) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [JaCoCo Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ [PMD Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Upload PMD Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pmd-report
          path: target/pmd.xml
