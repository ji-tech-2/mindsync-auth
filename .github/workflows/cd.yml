name: CD

on:
  workflow_run:
    workflows: ["Artifact"]
    types:
      - completed
    branches:
      - main

env:
  REPO_NAME: mindsync-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Extract Version from POM
        id: get_version
        run: echo "VERSION=v$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT

      - name: Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/${{ env.REPO_NAME }}
            IMAGE_TAG=${{ steps.get_version.outputs.VERSION }}

            docker pull $IMAGE_NAME:$IMAGE_TAG

            if docker ps -a | grep ${{ env.REPO_NAME }}; then
              docker stop ${{ env.REPO_NAME }}
              docker rm ${{ env.REPO_NAME }}
            fi

            docker run -d \
              -p 80:8080 \
              --name ${{ env.REPO_NAME }} \
              --restart always \
              -e EMAIL_USERNAME="${{ secrets.EMAIL_USERNAME }}" \
              -e EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
              -e RESEND_API="${{ secrets.RESEND_API }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              $IMAGE_NAME:$IMAGE_TAG

            docker image prune -f
